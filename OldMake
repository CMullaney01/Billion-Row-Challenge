ifndef NTHREADS
NTHREADS := $(shell nproc --all 2>/dev/null || sysctl -n hw.logicalcpu)
endif

CXX := g++
CXXFLAGS := -std=c++11 -O3 -march=native -mtune=native -flto -Wall -Wextra -Wpedantic \
            -Wformat=2 -Wconversion -Wundef -Winline -Wimplicit-fallthrough -DNTHREADS=$(NTHREADS)

ifdef DEBUG
CXXFLAGS += -D_FORTIFY_SOURCE=2 -D_GLIBCXX_ASSERTIONS \
            -fsanitize=address -fsanitize=undefined -g \
            -fstack-protector-strong
endif

all: bin/ bin/create-sample bin/analyze bin/main bin/main_profiled

bin/:
	mkdir -p bin/

.PHONY: profile
profile: bin/analyze_profiled
	perf record --call-graph dwarf bin/analyze_profiled measurements-1M.txt

bin/create-sample: create-sample.c
	$(CC) $(CFLAGS) $^ -lm -o $@

bin/analyze: analyze.c
	$(CC) $(CFLAGS) $^ -o $@

bin/main: src/main.cpp src/classes/*.cpp
	$(CXX) $(CXXFLAGS) -I src/includes $< src/classes/*.cpp -o $@

bin/main_profiled: src/main.cpp src/classes/*.cpp
	$(CXX) $(CXXFLAGS) -pg -I src/includes $< src/classes/*.cpp -o $@

.PHONY: clean
clean:
	rm -r bin/
